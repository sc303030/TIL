# 트랜잭션 관리2

### 회복(recovery)

- 데이터베이스를 장애발생 이전의 일관된 상태로 복원시키는 것
- 회복의 기본 원리
    - 덤프 : 다른 저장장치로 복제
    - 로그 : 데이터 아이템의 옛 값과 개 값을 별도의 파일에 기록
- 회복을 위한 조치
    - redo : 가장 최근 복제본 + 로그 → 데이터 에비스 복원
    - undo : 로그 + 모든 변경들을 취소 → 원래의 데이터베이스 상태로 복원
- undo : 단일 연산에 대해 적용
- rollback : 한 트랜잭션에 대해 적용
- 버퍼의 내용을 디스크에 기록하는 것을 가능하면 최대한 줄임으로써 성능을 향상시키는 것이 중요
- 트랜잭션이 버퍼에는 갱신 사항을 반영했지만 버퍼의 내용이 디스크에 기록되기 전에 고장이 발생할 수 있음
- 고장이 발생하기 전에 트랜잭션이 완료 명령을 수행했다면 회복 모듈은 이 트랜잭션의 갱신 사항을 재수행하여 트랜잭션의 갱신이 지속성을 갖도록 해야 함
- 고장이 발생하기 전에 트랜잭션이 완료 명령을 수행하지 못했다면 원자성을 보장하기 위해서 이 트랜잭션이 데이터베이스에 반영했을 가능성이 있는 갱신 사항을 취소해야 함

### 재해적 고장

- 디스크가 손상을 입어서 데이터베이스를 읽을 수 없는 고장
- 재해적 고장으로부터 회복은 데이터베이스를 백업해 놓은 자기 테이프를 기반으로 함

### 비재해적 고장

- 그 이외의 고장으로 대부분의 회복 알고리즘들은 비재해적 고장에 적용됨
- 로그를 기반으로 한 즉시 갱신, 로그를 기반으로 한 지연 갱신, 그림자 페이징등 여러 알고리즘이 사용됨

### 데이터베이스 로그

- 이중 로그 : 로그를 두 개의 디스크에 중복해서 저장하는 것
- 각 로그 레코드가 어떤 트랜잭션에 속한 것인가를 식별하기 위해서 id를 가짐

### 로그 레코드 유형

- [id, start]
- [id, x, old_val, new_val]
- [id, commit]
- [id, abort]

### 로그 우선 기록 규약

- 트랜잭션이 갱신한 데이터 항목을 디스크에 저장된 데이터베이스에 기록하기 전 로그 레코드에 먼저 기록함

### 로그를 사용한 즉시 갱신

- 즉시 갱신에서는 트랜잭션이 데이터베이스를 갱신한 사항이 주기억장치의 버퍼에 유지되다가 드랜잭션이 완료되기 전이라도 디스크의 데이터베이스에 기록될 수 있음
- 데티어 블록이 output되는 순서는 write되는 순서와 다를 수 있음
- 복구과정
    1. 로그 파일리 기록된 마지막부터 반대방향으로 순차적 탐색
    2. 로그에 저장된 각 트랜잭션의 로그 레코드에 대해서 start가 있으나 commit가 없으면 undo 연산 수행
    3. 로그 파일의 처음에 도달했으면 반태 방향으로 순차적으로 탐색
    4. 로그에 저장된 각 트랜잭션의 로그 레도크에 대해서 commit가 있으면 redo연산 수행

### 로그를 사용한 지연 갱신

- 트랜잭션의 실행이 성공적으로 완료될 때까지 갱신 내용을 디스크에 저장하지 않고 지연시킴
    - undo 연산이 필요 없음
    - 로그 레코드 형식 <id, x, new> old_val 불필요
- 복구과정
    1. 로그 파일의 처음부터 기록을 순차적으로 검색
    2. 로그에 저장된 각 트랜잭션의 로그 레코드에 대해서 <t, commit>가 있으면 redo 연산을 수행
    3. <t,commit>가 없는 트랜잭션에 대한 로그 레코드들은 무시
    
    ### 체크포인트
    
    - 시스템이 다운되기 직전에 완료된 트랜잭션이 데이터베이스를 갱신한 내뇽은 주기억장치의 버퍼에 남아 있으면서 아직 디스크에 기록되지 않았을 가능성이 높으르모 트랜잭션의 갱신 사항을 재 수행해야 하지만 시스템에 다운된 시점으로 부터 오래 전에 완료된 트랜잭션들이 데이터베이스를 갱신한 사항은 이미 디스크에 반영되었을 가능성이 큼
    - dbms가 로그를 사용하더라도 어떤 트랜잭션의 갱신 사항이 주기억장치 버퍼로부터 디스크에 기록되었는가를 구분할 수 없으므로 회복 시 재 수행할 트랜잭션의 수를 줄이기 휘애서 주기적으로 체크포인트를 수행함
    - 체크포인트 시점에는 주기억장치의 버퍼 내용이 드스크에 장제로 기록되므로, 체크포인트를 수행하면 디스크 상에서 로그와 데이터베이스의 내용이 일치하게 됨
    - 수행되는 작업
        - 수행중인 트랜잭션을 일시적으로 중지
        - 주기억장치의 데이터베이스 버터를 디스크에 강제로 출력